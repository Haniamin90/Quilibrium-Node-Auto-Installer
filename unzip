#!/bin/bash

# Step 1: Update package lists
echo "Updating package lists..."
apt-get update || { echo "Failed to update package lists! Exiting..."; exit 1; }

# Step 2: Install required packages
echo "Installing required packages..."
apt-get install -y curl wget git tmux nano unzip || { echo "Failed to install required packages! Exiting..."; exit 1; }

# Step 3: Install Rust
echo "Installing Rust..."
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y || { echo "Failed to install Rust! Exiting..."; exit 1; }
echo 'source $HOME/.cargo/env' >> $HOME/.profile
source $HOME/.profile

# Step 4: Download and install Go
echo "Installing Go..."
wget https://go.dev/dl/go1.20.11.linux-amd64.tar.gz || { echo "Failed to download Go! Exiting..."; exit 1; }
tar -C /usr/local -xzf go1.20.11.linux-amd64.tar.gz || { echo "Failed to extract Go! Exiting..."; exit 1; }
echo 'export PATH=$PATH:/usr/local/go/bin' >> $HOME/.profile
source $HOME/.profile

# Step 5: Clone ceremonyclient repository
echo "Cloning ceremonyclient repository..."
git clone https://github.com/Noretreat/ceremonyclient /ceremonyclient || { echo "Failed to clone repository! Exiting..."; exit 1; }
cd /ceremonyclient/node/.config || { echo "Failed to change directory! Exiting..."; exit 1; }

# Step 7: Create 20-quilibrium.conf
echo "Creating 20-quilibrium.conf..."
cat <<EOL > /etc/sysctl.d/20-quilibrium.conf
# Quilibrium buffering requirements, especially during sync.
# The value could be as low as 26214400, but everything would be slower.

net.core.rmem_max = 600000000
net.core.wmem_max = 600000000
EOL
if [[ $? -ne 0 ]]; then
  echo "Failed to create 20-quilibrium.conf! Exiting..."
  exit 1
fi

# Step 8: Start tmux session
echo "Starting tmux session..."
tmux new-session -d -s node || { echo "Failed to start tmux session! Exiting..."; exit 1; }

# Step 9: Run restart_node.sh in tmux session
echo "Running restart_node.sh in tmux session..."
tmux send-keys -t node 'cd /ceremonyclient/node/ && ./restart_node.sh' C-m || { echo "Failed to run restart_node.sh in tmux session! Exiting..."; exit 1; }

echo "Setup complete."
